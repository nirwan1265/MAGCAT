% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/TFisher_wrappers.R
\name{magcat_tfisher_pathways}
\alias{magcat_tfisher_pathways}
\title{Truncated Fisher (TPM) pathway test with gene-set permutations}
\usage{
magcat_tfisher_pathways(
  gene_results,
  pathways = NULL,
  species = NULL,
  pmn_gene_col = NULL,
  gene_col = "GENE",
  p_col = "P",
  ptrunc = 0.05,
  min_p = 1e-15,
  do_fix = TRUE,
  B_perm = 1000L,
  seed = NULL,
  analytic_logical = TRUE,
  output = FALSE,
  out_dir = "magcat_tpm"
)
}
\arguments{
\item{gene_results}{data.frame with at least gene + p-value columns.
Typically a MAGMA \code{.genes.out} file with "GENE" and "P".}

\item{pathways}{either:
\itemize{
\item a named list: each element is a character vector of gene IDs
in that pathway, OR
\item a data.frame with columns \code{pathway_id}, \code{gene_id}
(and optional \code{pathway_name}).
}}

\item{species}{optional; one of "maize", "sorghum", "arabidopsis", "plant".
If provided, built-in PMN pathways are loaded via \code{magcat_load_pathways()}.
You must provide either \code{pathways} OR \code{species}, but not both.}

\item{pmn_gene_col}{optional; passed to \code{magcat_load_pathways(gene_col=...)}
when \code{species} is used.}

\item{gene_col}{column name in \code{gene_results} containing gene IDs
(default "GENE").}

\item{p_col}{column name in \code{gene_results} containing gene-level p-values
(default "P").}

\item{ptrunc}{truncation threshold; p-values \eqn{p_i < p_{trunc}} are included
in the product (default 0.05).}

\item{min_p}{lower cap for very small p-values (default 1e-15).
Values \code{<= 0} are set to \code{min_p}; values \code{>= 1} are set to
\code{1 - 1/d}, where \code{d} is the number of p-values in that pathway.}

\item{do_fix}{logical; if TRUE, clean p-values with \code{fix_p_for_acat()}
before computing the stat.}

\item{B_perm}{Integer; number of gene-set permutations used to obtain
empirical TPM p-values (default 1000L). If 0, only the statistic
(and optional approximate analytic p) are returned.}

\item{seed}{optional integer random seed for permutations (ignored if
\code{B_perm == 0}).}

\item{analytic_logical}{logical; if TRUE, also compute \code{tpm_p_analytic}
using a chi-square approximation under independence
(\code{df = 2 * nincl}). This is an approximation, mainly for reference.}

\item{output}{logical; if TRUE, write a CSV of results to \code{out_dir}.}

\item{out_dir}{directory to write CSV when \code{output = TRUE}
(default "magcat_tpm").}
}
\value{
data.frame with columns:
\describe{
\item{pathway_id}{pathway identifier}
\item{pathway_name}{pathway name}
\item{n_genes}{number of genes used (with non-NA p-values)}
\item{gene_names}{semicolon-separated gene IDs}
\item{tpm_stat}{truncated Fisher statistic for that pathway}
\item{nincl}{number of p-values included after truncation}
\item{tpm_p_perm}{empirical p-value from gene-set permutations
(NA if \code{B_perm == 0})}
\item{tpm_p_analytic}{approximate analytic p-value via
chi-square(df = 2*nincl);
equals 1 when \code{nincl == 0} and
NA only if there are no valid p's.}
}
If \code{B_perm > 0}, rows are sorted by \code{tpm_p_perm} ascending;
otherwise by \code{tpm_stat} descending (larger stat = stronger signal).
If \code{output = TRUE}, an attribute \code{"file"} is attached with the CSV path.
}
\description{
For each pathway, this function:
\itemize{
\item takes gene-level p-values (e.g. from MAGMA .genes.out),
\item computes the truncated Fisher (TPM) statistic with threshold \code{ptrunc}:
\deqn{T = -2 \sum_{p_i < p_{trunc}} \log(p_i)}
\item (optionally) reports an approximate analytic p-value via a chi-square
distribution with \code{df = 2 * nincl},
\item calibrates the test using gene-set permutations to obtain an
empirical TPM p-value.
}
}
\details{
This implementation does NOT depend on TFisher or metap; everything is done
in base R. The permutation p-value is the one you should trust for inference.
}
